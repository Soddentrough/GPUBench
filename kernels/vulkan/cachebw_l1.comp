#version 450

layout(local_size_x = 256) in;

layout(set = 0, binding = 0) volatile buffer Data {
    vec4 data[];
} Buffer;

layout(push_constant) uniform PushConstants {
    uint mask;
} pushConstants;

void main() {
    uint globalId = gl_GlobalInvocationID.x;
    uint idx = globalId & pushConstants.mask;
    vec4 sum = vec4(0.0);

    for (uint i = 0; i < 2000; i++) {
        uint base = (idx + i * 8) & pushConstants.mask;
        sum += Buffer.data[(base + 0) & pushConstants.mask];
        sum += Buffer.data[(base + 1) & pushConstants.mask];
        sum += Buffer.data[(base + 2) & pushConstants.mask];
        sum += Buffer.data[(base + 3) & pushConstants.mask];
        sum += Buffer.data[(base + 4) & pushConstants.mask];
        sum += Buffer.data[(base + 5) & pushConstants.mask];
        sum += Buffer.data[(base + 6) & pushConstants.mask];
        sum += Buffer.data[(base + 7) & pushConstants.mask];
    }

    if (sum.x < 0.0) {
        Buffer.data[idx] = sum;
    }
}
